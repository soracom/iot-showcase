## 7 章 SORACOM Lagoon によるさらに高度な可視化とアラート通知

SORACOM のもう一つのサービス、Lagoon を体験しましょう。

### SORACOM Lagoon とは

SORACOM Lagoon はダッシュボード作成/共有サービスです。先ほどのハンズオンで使ったデータ収集、蓄積サービス SORACOM Harvest に集められたデータを対象に目的に応じて複数のグラフ、テーブル、地図等を組み合わせたダッシュボードを作成し、それらを共有できます。また、 収集するデータに対して閾値を設定しメール送信、LINE への通知、Webhook 等のアラートを設定することができます。

![](https://soracom.jp/img/fig_lagoon01.png)

### このハンズオンで作成するダッシュボード

はじめに今回のハンズオンで作成するダッシュボードを見てみましょう。

![](image/9-1.png)

![](image/9-2.png)

このダッシュボードは以下の機能を実現します。

- 左側のパネル (SORACOM Dynamic Image Panel)
  - センサーが検知した距離に応じて表示する画像を変えます。近づくと不審者アイコンに変わります。
- 右側のパネル (Graph Panel)
  - センサーが検知した距離の履歴をグラフで表示します。
  - 近距離の値が一定期間継続するとメールでアラートを送信します。
    - 赤い直線が閾値を表します。
    - アラート状態とそうでないときにグラフのタイトルのハートアイコンが変わります。

これらの機能がすべて Lagoon の標準機能で作成できます。

### SORACOM Lagoon を有効にする

SORACOM Lagoon を使うために設定を有効化しパスワードを設定します。

> Lagoon はダッシュボードを第三者と共有できますので、SORACOM ユーザーコンソールと異なる認証情報を使用します。そのため、最初にパスワードを設定します。

サイドメニューのデータ収集・蓄積・可視化セクションから SORACOM Lagoon をクリックし「SORACOM Lagoon の利用を開始する」ボタンをクリックします。

![](image/9-3.png)

パスワードを設定したら「SORACOM Lagoon console にアクセス」ボタンをクリックします。

![](image/9-4.png)

ログイン画面が表示されますので、メールアドレスと設定したパスワードでログインします。

![](image/9-5.png)

### Lagoon ダッシュボードの作成

それでは実際にダッシュボードの作成です。左上の `+` アイコンをクリックしダッシュボードを作成します。 `New dashboard` という名前でダッシュボードが作成されパネルの選択画面が表示されます。

![](image/9-6-0.png)

#### Graph Panel の作成

まずは可視化の効果がすぐに見えるグラフから作成していきましょう。

パネルの選択画面が表示されていると思いますので Graph アイコンをクリックします。

![](image/9-6.png)

表示されたパネルのタイトル (Panel Title となっているところ) をクリックした後、[編集] をクリックします。全般タブの [タイトル] の `Page Title` に代わり、適当な名前(例: `センサー履歴`) をつけます。  
（その際 `Page Title` が、入力した名前に変わります）

![](image/9-7.png)

メトリックタブでは使用している SIM を選択し(モザイク部分)、グラフに表示するメトリックとして `distance` が選択されていることを確認します。

![](image/9-8.png)

右上の ![ダッシュボードに戻る](image/9-7a.png) ボタンをクリックします。Harvest に送信されているデータがグラフ化されていることが確認できます。

#### SORACOM Dynamic Image Panel の作成

SORACOM Dynamic Image Panel ではデータに応じて表示する画像を動的に変更できます。今回表示する画像データは AWS S3 にアップロードしていますが、ネットワーク経由でアクセスできる場所であればどこでも構いません。

画面上部の「パネルを追加」ボタンをクリックします。

![](image/9-9.png)

パネルの選択画面を下にスクロールし SORACOM Dynamic Image Panel アイコンをクリックします。

![](image/9-10.png)

表示されたパネルのタイトル (Panel Title となっているところ) をクリックした後、[編集] をクリックします。全般タブの [タイトル] の `Page Title` に代わり、適当な名前(例: `誰か来たよ`) をつけます。

![](image/9-11.png)

メトリックタブでは使用している SIM を選択し(モザイク部分)、グラフに表示するメトリックとして `distance` が選択されていることを確認します。

![](image/9-12.png)

設定タブで以下のように指定します。

- 背景画像の URL: `https://binary-parser-playground-dev.s3.amazonaws.com/`

次に、同じタブ内で「変数を追加」ボタンをクリックし、以下のように入力します。

- メトリック
    - 名前: **A-distance**
    - 最小値: `0`
    - 間隔: `20`
    - 最大値: `20`

クエリ A の結果 `distance` の値が 0cm から 10cm の時は変数に `0` がセットされ、10cm 以上の時には変数に `20` がセットされます。この数値を元にファイル名を算出しパネルに表示します。

![](image/9-13.png)

右上の ![ダッシュボードに戻る](image/9-7a.png) ボタンをクリックします。

#### 表示の更新間隔を変更して保存する

右上の時計マーク (たいていは [Last 6 hours] と表示されています)をクリックして表示されるダイアログで [自動更新] を `5秒` にしてから [適用] をクリックします。

![](images/9-13-1.png)

注意: SORACOM Lagoon のダイアログにおける自動更新と、SORACOM Lagoonの契約プランにおけるデータ更新間隔は長い方が優先されます。(例: SORACOM Lagoonの Maker プランの更新間隔は30秒となっているため、SORACOM Lagoon上の更新間隔を5秒としても次回の更新は30秒となります)

あとは ![ダッシュボードを保存](images/9-13-2.png) をクリックし、ダッシュボード名を設定して (例: `handson`) 完了します。

#### 動かしてみる

Raspberry Pi で `send_to_harvest.py` を動かしてから、センサーとの距離を変えて画像が変わることを確認してください。また、パネルのサイズや配置をお好みに応じて調整するとよいでしょう。

##### トラブルシュート

画像がうまく表示されない場合は以下を確認してください。

「すべての画像リンクを表示」ボタンをクリックします。

![](image/9-14.png)

最小値・間隔・最大値を元に計算された取り得る値(potential values)に応じて複数の画像の URL が表示されますので、想定した URL となっているかを確認してください。

![](image/9-15.png)

「プレビュー」ボタンをクリックすると、それぞれの URL にアクセスできるかを確認できます。

![](image/9-16.png)

### アラートメールの送信設定

#### 通知チャネルの作成

Lagoon のアラートは、別途設定した通知チャネルヘ送信します。複数のパネルで通知先を共通化したい場合に便利です。チャネルはメール、LINE、Slack などさまざまありますが、このハンズオンではメールを使用します。

左上の ベルアイコンをクリックし新しい通知チャネルを作成します。

![](image/9-17.png)

`New Channel` ボタンをクリックします。

![](image/9-18.png)

以下の値を入力します。

- 名前: 任意の名前 (例: `誰か来たセンサー`)
- タイプ: Email
- すべてのアラートで送信: チェックを外す
- Email addreses: ご自分のメールアドレス

![](image/9-19.png)

「送信テスト」ボタンを押すと宛先が正しいか確認できます。しばらくすると以下のような `[Alerting] Test Notifications` メールが届きます。

![](image/9-20.png)

##### トラブルシュート

メールが届かない場合は以下の点を確認してください。

- メールアドレスが正しいか。
- `no-reply@soracom.jp` からのメールが迷惑メールに判定されていたり、受信フィルタで拒否されていないか。

#### グラフへのアラートの設定

先ほど作成したグラフ (例に従って設定した場合は `センサー履歴`) のタイトル部分をクリックし、[編集] をクリックした後、アラートタブから「アラートを作成」ボタンをクリックします。

![](image/9-21.png)

アラート設定として以下の値を入力します。過去1分間の平均値が50 cmを下回った場合にアラートを通知する設定となります。

- WHEN: `avg()`
- OF: `query (A, 1m, now)`
- IS BELOW: `10`

![](image/9-22.png)

通知の設定で送り先の `+` アイコンをクリックします。

![](image/9-23.png)
![](image/9-24.png)
![](image/9-25.png)

あとは ![ダッシュボードを保存](images/9-13-2.png) をクリックして保存します。

![](image/9-26.png)
![](image/9-27.png)
![](image/9-28.png)
![](image/9-29.png)
![](image/9-30.png)
![](image/9-31.png)
![](image/9-32.png)

### おわり

おめでとうございます！皆さんは、IoT 体験キット 〜距離測定センサー〜を完了しました。SORACOM を使ったハンズオンを楽しんで頂けましたでしょうか？

さらに SORACOM に興味を持っていただいた方は、以下の Getting Started もご覧ください！

SORACOM Getting Started
https://dev.soracom.io/jp/start/
